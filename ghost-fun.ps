// ================================
// ðŸ“¦ Create Module
// ================================
hsx modules: create > ghost-fun.ps

// ================================
// ðŸŒ€ Fun Runtime with Persistence & Reactions
// ================================
hsx:fun

const runtime = window.HSXRuntime?.prototype;

window.ghostSystem = {
  ready: false,

  ghosts: [],
  container: null,
  audio: null,
  calendarId: null,
  canvasLayers: [],
  ctxLayers: [],
  history: [],
  haunted: false,
  hauntingLevel: 0,

  personalities: ["friendly","angry","lonely","playful","ancient","curious"],
  whispers: [
    "We remember your footsteps.",
    "The moon is listening.",
    "Do not follow the lights.",
    "They are closer than you think.",
    "You were expected."
  ],

  getMoonPhase(){
    const d = new Date();
    const lp = 2551443;
    const new_moon = new Date(1970,0,7,20,35,0);
    const phase = ((d - new_moon)/1000) % lp;
    const n = Math.floor(phase/(lp/8));
    return ["new","waxing crescent","quarter","waxing gibbous","full","waning gibbous","last quarter","waning crescent"][n];
  },

  init(containerId, canvasIds, sound){
    const container = document.getElementById(containerId);
    this.container = container;
    this.calendarId = containerId;

    const h = new Date().getHours();
    if(h >= 21 || h <= 5){
      this.haunted = true;
      container.style.boxShadow = "0 0 120px rgba(180,180,255,1)";
    }

    window.toggleHaunt = () => {
      this.haunted = !this.haunted;
      container.style.boxShadow = this.haunted
        ? "0 0 140px rgba(200,200,255,1)"
        : "0 0 40px rgba(120,120,255,0.7)";
    };

    canvasIds.forEach(id => {
      const canvas = document.getElementById(id);
      const ctx = canvas.getContext("2d");
      canvas.width = container.clientWidth;
      canvas.height = container.clientHeight;
      this.canvasLayers.push(canvas);
      this.ctxLayers.push(ctx);
    });

    this.audio = new Audio(sound);
    this.audio.volume = 0.5;

    const saved = localStorage.getItem(`ghosts-${containerId}`);
    if(saved) this.ghosts = JSON.parse(saved);

    const hist = localStorage.getItem(`ghost-history-${containerId}`);
    if(hist) this.history = JSON.parse(hist);

    this.ghosts.forEach(g => this.addGhost(g.date, g.note, g.html, true));

    if(runtime?.emotionActive){
      runtime.emotions[":)"] = () => console.log("ðŸ‘» Ghost feels warm");
      runtime.emotions[":("] = () => console.log("ðŸ‘» Ghost feels sorrow");
    }

    setInterval(()=>{
      if(!this.haunted || this.ghosts.length === 0) return;
      const g = this.ghosts[Math.floor(Math.random()*this.ghosts.length)];
      const w = this.whispers[Math.floor(Math.random()*this.whispers.length)];
      console.log(`ðŸ•¯ ${g.personality} ghost whispers: "${w}"`);
    }, 10000);

    setInterval(()=>{
      const moon = this.getMoonPhase();
      this.hauntingLevel = this.ghosts.length + (moon==="full" ? 5 : 1);
      console.log("ðŸŒ• Moon:", moon, "Haunting:", this.hauntingLevel);
    }, 20000);

    setInterval(()=>{
      this.ghosts.forEach(g => {
        g.memory = (g.memory || 0) + 1;
        if(Math.random()<0.3){
          const other = this.ghosts[Math.floor(Math.random()*this.ghosts.length)];
          if(other !== g){
            g.relations = g.relations || {};
            g.relations[other.time] = Math.random()>0.5?"friend":"rival";
          }
        }
      });
    }, 15000);

    this.animateGhost = (el, effect="default") => {
      el.style.transition = "opacity 1s, transform 0.5s";
      el.style.opacity = "1";
      let dx=(Math.random()-0.5)*2, dy=(Math.random()-0.5)*2;

      const float = () => {
        let t=parseFloat(el.style.top), l=parseFloat(el.style.left);
        el.style.top=`${t+dy}px`; el.style.left=`${l+dx}px`;
        if(t<0||t>window.innerHeight-60) dy*=-1;
        if(l<0||l>window.innerWidth-60) dx*=-1;
        requestAnimationFrame(float);
      };
      requestAnimationFrame(float);
    };

    this.fogParticles = this.canvasLayers.map(c =>
      Array.from({length:60}, ()=>({
        x:Math.random()*c.width, y:Math.random()*c.height,
        r:Math.random()*30+20, s:Math.random()*0.3+0.1,
        a:Math.random()*0.3+0.1, dx:Math.sin(Math.random()*6)*0.3
      }))
    );

    this.spiritParticles = [];

    const spawnSpirit = () => this.spiritParticles.push({
      x:Math.random()*container.clientWidth,
      y:container.clientHeight+10,
      r:Math.random()*10+5,
      s:Math.random()*1+0.5,
      a:Math.random()*0.5+0.3
    });

    const animateFog = () => {
      this.ctxLayers.forEach((ctx,i)=>{
        ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height);
        this.fogParticles[i].forEach(p=>{
          p.y-=p.s; p.x+=p.dx;
          if(p.y+p.r<0) p.y=ctx.canvas.height+p.r;
          ctx.beginPath();
          ctx.fillStyle=`rgba(200,200,255,${p.a})`;
          ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
          ctx.fill();
        });
      });

      if(Math.random()<0.03) spawnSpirit();
      requestAnimationFrame(animateFog);
    };
    animateFog();

    this.ready = true;
    console.log("ðŸ‘» Ghost System initialized and ready");
  },

  // ================================
  // ðŸ‘» Add Ghost
  // ================================
  addGhost(date, note, ghostHTML, skipPersist=false){
    if (!this.ready) {
      console.warn("ðŸ‘» Ghost system not ready yet");
      return;
    }

    if(!date) return alert("Pick a date!");
    const today = new Date().toISOString().slice(0,10);

    let effect="default";
    if(date===today) effect="today";
    else if(new Date(date).getDay()===0||new Date(date).getDay()===6) effect="weekend";
    else if(date.endsWith("-10-31")) effect="spooky";

    const personality=this.personalities[Math.floor(Math.random()*this.personalities.length)];

    const entry={date,note,time:Date.now(),effect,personality,html:ghostHTML||"",memory:0,relations:{}};
    this.ghosts.push(entry);
    this.history.push({action:"created",...entry});

    if(!skipPersist){
      localStorage.setItem(`ghosts-${this.calendarId}`,JSON.stringify(this.ghosts));
      localStorage.setItem(`ghost-history-${this.calendarId}`,JSON.stringify(this.history));
    }

    const li=document.createElement("li");
    li.textContent=`${date}: ${note} (${personality})`;
    document.getElementById("ghost-list").appendChild(li);

    if(ghostHTML){
      const w=document.createElement("div");
      w.innerHTML=ghostHTML;
      const el=w.firstElementChild;
      el.style.top=`${Math.random()*(window.innerHeight-60)}px`;
      el.style.left=`${Math.random()*(window.innerWidth-60)}px`;
      document.body.appendChild(el);
      this.animateGhost(el,effect);
      try{this.audio.currentTime=0;this.audio.play();}catch{}
    }
  }
};

// ðŸ” Auto-boot the engine
window.addEventListener("load", () => {
  if (window.ghostSystem?.init) {
    window.ghostSystem.init("calendar-container", ["fog-canvas"], "ghost-sound.mp3");
  }
});

hsx end
